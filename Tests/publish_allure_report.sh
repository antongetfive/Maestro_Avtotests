#!/bin/bash

# -------------------------------
# 1) –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------
RESULTS_DIR="allure-results"
DOCS_DIR="docs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
REPORT_DIR="$DOCS_DIR/report_$TIMESTAMP"

# -------------------------------
# 2) –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
# -------------------------------
REPO_URL=$(git config --get remote.origin.url)

if [ -z "$REPO_URL" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω."
  exit 1
fi

# -------------------------------
# 3) –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ allure-results
# -------------------------------
if [ ! -d "$RESULTS_DIR" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ $RESULTS_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
  exit 1
fi

# -------------------------------
# 4) –°–æ–∑–¥–∞—ë–º docs/report_TIMESTAMP/
# -------------------------------
echo "üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É –æ—Ç—á—ë—Ç–∞: $REPORT_DIR"
mkdir -p "$REPORT_DIR"

# -------------------------------
# 5) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á—ë—Ç–∞
# -------------------------------
echo "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é Allure Report..."
allure generate "$RESULTS_DIR" --clean -o "$REPORT_DIR"

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞!"
  exit 1
fi

# -------------------------------
# 6) –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
# -------------------------------
echo "üì§ –ö–æ–º–º–∏—Ç –∏ –ø—É—à –æ—Ç—á—ë—Ç–∞..."
git add -A

if git diff --cached --quiet; then
  echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ—Ç—á—ë—Ç –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)."
else
  git commit -m "Add report $TIMESTAMP"
  git push origin HEAD
fi

# -------------------------------
# 7) –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É GitHub Pages
# -------------------------------
USER=$(echo "$REPO_URL" | sed -E 's#.*github.com[:/](.*)/(.*)\.git#\1#')
REPO=$(echo "$REPO_URL" | sed -E 's#.*github.com[:/](.*)/(.*)\.git#\2#')

GH_REPORT_URL="https://${USER}.github.io/${REPO}/report_$TIMESTAMP/"
GH_INDEX_URL="https://${USER}.github.io/${REPO}/"

# -------------------------------
# 8) –ì–æ—Ç–æ–≤–æ!
# -------------------------------
echo ""
echo "üéâ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
echo "----------------------------------------"
echo "üìÑ –£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á—ë—Ç:"
echo "$GH_REPORT_URL"
echo ""
echo "üìö –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç—á—ë—Ç–æ–≤:"
echo "$GH_INDEX_URL"
echo "----------------------------------------"
