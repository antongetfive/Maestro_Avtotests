#!/bin/bash

# -------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------
set -e # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞..."

# -------------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
# -------------------------------
echo "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é Allure –æ—Ç—á–µ—Ç..."
rm -rf docs
allure generate allure-results --clean -o docs

# –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫—ç—à–∞
TIMESTAMP=$(date +%s)
echo "<!-- Timestamp: $TIMESTAMP -->" >> docs/index.html

if [ ! -f "docs/index.html" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –æ—Ç—á–µ—Ç –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
    exit 1
fi

echo "‚úÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (timestamp: $TIMESTAMP)"

# -------------------------------
# –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Git
# -------------------------------
echo "üì§ –ü—É–±–ª–∏–∫—É—é –≤ GitHub..."
git add -A

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
COMMIT_MSG="update allure reports $(date '+%Y-%m-%d %H:%M:%S') - $TIMESTAMP"
git commit -m "$COMMIT_MSG" || echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"

git push

echo "‚úÖ –û—Ç—á–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"

# -------------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—É–±–ª–∏—á–Ω–æ–π —Å—Å—ã–ª–∫–∏ —Å –æ–±—Ö–æ–¥–æ–º –∫—ç—à–∞
# -------------------------------
REPO_URL=$(git config --get remote.origin.url)

get_github_pages_url() {
    local url="$1"
    
    # https://github.com/user/repo.git
    if [[ "$url" =~ github.com[:/]([^/]+)/([^/.]+)\.git$ ]]; then
        echo "https://${BASH_REMATCH[1]}.github.io/${BASH_REMATCH[2]}/"
    
    # git@github.com:user/repo.git  
    elif [[ "$url" =~ :([^/]+)/([^/.]+)\.git$ ]]; then
        echo "https://${BASH_REMATCH[1]}.github.io/${BASH_REMATCH[2]}/"
    
    # https://github.com/user/repo
    elif [[ "$url" =~ github.com[:/]([^/]+)/([^/.]+)$ ]]; then
        echo "https://${BASH_REMATCH[1]}.github.io/${BASH_REMATCH[2]}/"
    else
        return 1
    fi
}

GH_PAGES_URL=$(get_github_pages_url "$REPO_URL")

if [ -n "$GH_PAGES_URL" ]; then
    echo ""
    echo "üéâ –û–¢–ß–ï–¢ –û–ü–£–ë–õ–ò–ö–û–í–ê–ù!"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "üìä –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞:"
    echo "   ${GH_PAGES_URL}index.html"
    echo ""
    echo "üîÑ –°—Å—ã–ª–∫–∞ —Å –æ–±—Ö–æ–¥–æ–º –∫—ç—à–∞:"
    echo "   ${GH_PAGES_URL}index.html?t=$TIMESTAMP"
    echo ""
    echo "üåê –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:"
    echo "   $GH_PAGES_URL"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    # –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–≤–µ—Ä—Å–∏—è —Å timestamp)
    if command -v pbcopy > /dev/null; then
        echo "${GH_PAGES_URL}index.html?t=$TIMESTAMP" | pbcopy
        echo "üìã –°—Å—ã–ª–∫–∞ —Å –æ–±—Ö–æ–¥–æ–º –∫—ç—à–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"
    elif command -v xclip > /dev/null; then
        echo "${GH_PAGES_URL}index.html?t=$TIMESTAMP" | xclip -selection clipboard
        echo "üìã –°—Å—ã–ª–∫–∞ —Å –æ–±—Ö–æ–¥–æ–º –∫—ç—à–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"
    fi
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Å—ã–ª–∫—É GitHub Pages"
fi

# -------------------------------
# –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub Pages
# -------------------------------
echo ""
echo "‚è≥ –û–∂–∏–¥–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GitHub Pages (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 5 –º–∏–Ω—É—Ç)..."
echo "üí° –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –æ—Ç—á–µ—Ç:"
echo "   - –ù–∞–∂–º–∏—Ç–µ Ctrl+F5 –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
echo "   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Å—ã–ª–∫—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º ?t=$TIMESTAMP"
echo "   - –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞"