#!/bin/bash

# -------------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------
DOCS_DIR="docs"
REPO_URL=$(git config --get remote.origin.url)

if [ -z "$REPO_URL" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω."
  exit 1
fi

echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# -------------------------------
# –û—á–∏—Å—Ç–∫–∞ docs/
# -------------------------------
echo "‚úÖ –û—á–∏—â–∞—é $DOCS_DIR..."
rm -rf "$DOCS_DIR"
mkdir -p "$DOCS_DIR"

# -------------------------------
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ allure-results
# -------------------------------
if [ ! -d "allure-results" ]; then
  echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è allure-results –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
  echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
  ls -la
  exit 1
fi

echo "‚úÖ –ù–∞—à–µ–ª allure-results"
echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ allure-results:"
ls -la "allure-results/" | head -10

# -------------------------------
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
# -------------------------------
echo "‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Allure –æ—Ç—á–µ—Ç..."

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ docs
allure generate "allure-results" --clean -o "$DOCS_DIR"

if [ $? -eq 0 ]; then
  echo "‚úÖ –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –≤ $DOCS_DIR"
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–æ—Å—å
  echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–∞:"
  ls -la "$DOCS_DIR/" | head -10
else
  echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç"
  echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Allure: allure --version"
  exit 1
fi

# -------------------------------
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
# -------------------------------
if [ -z "$(ls -A "$DOCS_DIR")" ]; then
    echo "‚ùå –í $DOCS_DIR –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ docs:"
    ls -la "$DOCS_DIR"
    exit 1
fi

echo "üìÇ –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã–µ –∫ –∫–æ–º–º–∏—Ç—É –≤ docs:"
find "$DOCS_DIR" -type f | head -10

# -------------------------------
# Git commit + push
# -------------------------------
echo "‚úÖ –î–æ–±–∞–≤–ª—è—é —Ñ–∞–π–ª—ã –≤ git..."
git add -f "$DOCS_DIR"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff --cached --quiet; then
    echo "‚ÑπÔ∏è –ù–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å."
else
    echo "‚úÖ –°–æ–∑–¥–∞—é –∫–æ–º–º–∏—Ç..."
    git commit -m "update allure reports $(date '+%Y-%m-%d %H:%M:%S')"
    
    echo "‚úÖ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git push origin HEAD
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É—à–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
        exit 1
    fi
fi

# -------------------------------
# GitHub Pages —Å—Å—ã–ª–∫–∞
# -------------------------------
if [[ "$REPO_URL" =~ github.com[:/]([^/]+)/([^/.]+) ]]; then
    USER="${BASH_REMATCH[1]}"
    REPO="${BASH_REMATCH[2]%.git}"
    
    GH_PAGES_URL="https://${USER}.github.io/${REPO}/"
    
    echo "üéâ –í—Å–µ –æ—Ç—á—ë—Ç—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã!"
    echo "üìé GitHub Pages: $GH_PAGES_URL"
    echo "üìé –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á–µ—Ç: ${GH_PAGES_URL}index.html"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è GitHub Pages"
    echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $REPO_URL"
fi