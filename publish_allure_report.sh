#!/bin/bash

# -------------------------------
# 1) –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------

# –ü–∞–ø–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Maestro
ALLURE_RESULTS_DIR="allure-results"

# –ü–∞–ø–∫–∞, –∫—É–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è HTML-–æ—Ç—á—ë—Ç
ALLURE_REPORT_DIR="allure-report"

# –ü–∞–ø–∫–∞, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π GitHub Pages –ø—É–±–ª–∏–∫—É–µ—Ç —Å–∞–π—Ç
DOCS_DIR="docs"

# –ü–æ–ª—É—á–µ–Ω–∏–µ GitHub URL (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
REPO_URL=$(git config --get remote.origin.url)

# -------------------------------
# 2) –ü—Ä–æ–≤–µ—Ä–∫–∏
# -------------------------------

if [ -z "$REPO_URL" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞."
  exit 1
fi

if [ ! -d "$ALLURE_RESULTS_DIR" ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç –ø–∞–ø–∫–∏ allure-results."
  echo "–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã (—Ç–≤–æ–π run_all.sh)."
  exit 1
fi

# -------------------------------
# 3) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure Report
# -------------------------------

echo "‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π Allure Report..."
allure generate "$ALLURE_RESULTS_DIR" --clean -o "$ALLURE_REPORT_DIR"

if [ $? -ne 0 ]; then
  echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç."
  exit 1
fi

# -------------------------------
# 4) –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docs/
# -------------------------------

echo "‚úÖ –û–±–Ω–æ–≤–ª—è—é –ø–∞–ø–∫—É docs/..."
rm -rf "$DOCS_DIR"
mkdir "$DOCS_DIR"
cp -r "$ALLURE_REPORT_DIR"/* "$DOCS_DIR"

# -------------------------------
# 5) Git commit + push
# -------------------------------

echo "‚úÖ –î–µ–ª–∞—é commit –∏ push..."

git add "$DOCS_DIR"
git commit -m "update allure report" --quiet

if [ $? -ne 0 ]; then
  echo "‚ÑπÔ∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –Ω–µ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∏—Ç—å (–Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)."
else
  git push
fi

# -------------------------------
# 6) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ GitHub Pages
# -------------------------------

USER=$(echo "$REPO_URL" | sed -E 's#.*github.com[:/](.*)/(.*)\.git#\1#')
REPO=$(echo "$REPO_URL" | sed -E 's#.*github.com[:/](.*)/(.*)\.git#\2#')

GH_PAGES_URL="https://${USER}.github.io/${REPO}/"

# -------------------------------
# 7) –ì–æ—Ç–æ–≤–æ
# -------------------------------

echo "‚úÖ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
echo "üìé –°—Å—ã–ª–∫–∞ –Ω–∞ GitHub Pages:"
echo "$GH_PAGES_URL"
echo ""
echo "–ï—Å–ª–∏ –≤ Pages –≤–∫–ª—é—á—ë–Ω deploy –∏–∑ –ø–∞–ø–∫–∏ docs, –æ—Ç—á—ë—Ç –æ—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ä–∞–∑—É."
